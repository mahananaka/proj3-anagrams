<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>

<!-- Bootstrap requires the following three meta tags to appear first -->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">


<title>Vocabulary Anagram</title>

<!-- Javascript and Cascading Style Sheets (css) libraries -->
<!-- mostly from content delivery networks                 -->

<!-- jquery; CDN load is usually quick because it's likely cached -->
<script type="text/javascript"
     src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js">
</script>

<!-- Bootstrap stylesheet let's us have a 'responsive' layout; -->
<!-- 12 column grid rearranges itself for smaller screens or windows. -->

<!-- per http://getbootstrap.com/getting-started/  -->
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
 href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
 integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
  crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script
 src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
 integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
 crossorigin="anonymous">
</script>

<!-- Our own css file.  Note how we can link directly here and not -->
<!-- write any routing code in the Flask application. -->
<link rel="stylesheet" href="/static/jumble.css" />

</head>

<body>
<div class="container">

  <div class="row">
    <div class="col-xs-6 text-center">
      <h1>Words</h1>
    </div>
  </div>
<!-- Vocabularly words layed out in 6 columns;
  -- bootstrap may collapse to fewer columns and
  -- more rows if the window is narrow.
  -->
<div class="row">
  {% for word in g.vocab %}
    <div id="vocab{{loop.index}}" class="col-xs-2 text-center">{{ word }}</div>
    {% if loop.index is divisibleby 3 %}
    </div> <!-- row -->
    <div class="row">
    {% endif %}
  {% endfor %}
</div> <!-- row -->

<br />

<div class="row">
  <div class="col-xs-6 text-center">
   Use letters from
  </div>
  </div><div class="row">
  <div class="col-xs-6 text-center lead">
    {% for letter in session.jumble %}
        <span id="jumble{{loop.index}}">{{ letter}}</span>
    {% endfor %}
  </div>
  </div><div class="row">
  <div class="col-xs-6 text-center">
    to spell {{session.target_count}} words from the list.
  </div> <!-- col -->
</div> <!-- row -->
<br />
<div class="row">
  <div class="col-xs-6 text-center">
  <form id="entry" method="POST" action="/_check">
    <label for="attempt">Word:</label>
    <input id="attempt" name="attempt" type="text" width="15"
      autocomplete="off"  autofocus />
  </form>
</div></div>

<br />

<p id="message"></p>
<p id="results"></p>

<!-- hidden by css; element hold helper data -->
<span id="vocabcount" class="hidden">{{ g.vocab|length }}</span> 
<span id="jumble" class="hidden">{{ session.jumble }}</span>

<script>
// Some global variables
var fadedStyle = "fadedColor";
var normalStyle = "defaultColor";

// Suppress normal form submission
$("#entry").submit( function(event) {
   event.preventDefault();
  });

// On each keystroke, ask the server if word spelled correctly
//
$("#attempt").keyup(function(event) {
    var txt = $("#attempt").val();  // Current content of the input field
    var keycode = event.which;      // They key that just went up
    var letter = String.fromCharCode(keycode);
    console.log(keycode +":"+letter);
    //if user used the backspace or delete stop the function. When 
    //clearInput() is called it erases the txt, keyup is still fires
    //when this happens so we add a check for if txt is an empty 
    //string as well
    if(keycode == 8 || keycode == 46 || txt == ""){ 
        updateVocabList(txt);
        updateJumble(txt); 
        return
    }

    // stop as well if the letter typed is not in the jumble
    if (!validLastChar(txt,letter.toLowerCase())) { 
        updateVocabList(txt);
        updateJumble(txt); //will remove the invalid char
        return 
    }

    //All checks are good lets proceed to make an Ajax post to server
    $.post( "/_check", { attempt: txt }, 
        function(data) { //this function, written inline, is when the response comes.
            if (data.result.flash) {
                if (data.result.flash == "Success") {
                    $(location).attr("href", "/success");
                }
    
                if (data.result.flash.includes("You found")) {
                    clearInput();
                    clearAlerts();

                    if (data.result.matches) {
                        var foundWords = "";

                        for(var i=0; i<data.result.matches.length; i++) {
                          foundWords = foundWords + showTiles(data.result.matches[i]) + "<br>";
                        }
                        
                        $("#results").html(foundWords);
                    }
                }

                if (data.result.flash.includes("You already")) {
                    clearInput();
                    $("#message").html(data.result.flash);
                }

                if (data.result.flash.includes("be made from")){
                    clearInput();
                    $("#message").html(data.result.flash);
                }
            }
        }
    );

    updateVocabList(txt);
    updateJumble(txt);
});

function validLastChar(word, letter){
  //returns true letter is valid
  if(!$("#jumble").html().includes(letter))
    return false;
  else
    return true;
}

function clearAlerts(){
  $("#message").html("");
}

function clearInput(){
  $("#attempt").val("");
  updateVocabList("");
  updateJumble("");
}

function updateJumble(input){
    var jumbleCount = $("#jumble").html().length;

    resetJumbleStyle();

    for(var i=0; i<input.length; i++){

        if(!findUnusedLetter(input[i],jumbleCount)){
            var word = $("#attempt").val();
            $("#attempt").val(word.substr(0,word.length-1)); //chop off the last letter entered
        }
    }
}

function findUnusedLetter(letter, count){
    for(var i=1; i<=count; i++){
        var element = "#jumble" + i;
        var htmlText = $(element).html();
        var textClass = $(element).attr("class")

        if(htmlText.includes(letter) && textClass == normalStyle){
            console.log(element + " fading.");
            $(element).addClass(fadedStyle);
            $(element).removeClass(normalStyle);
            return true;
        }
    }
}

function resetJumbleStyle(){
    var count = $("#jumble").html().length;
    for(var i=1; i<=count; i++){
        var element = "#jumble" + i;

        $(element).addClass(normalStyle);
        $(element).removeClass(fadedStyle);
    }
}

function updateVocabList(input){
    var count = $("#vocabcount").html();

    for(var i=1; i<=count;i++){
        var element = "#vocab" + i;
        var valid = true;

        //cycle through the each character in the input
        //check if each vocab word contains this character
        for(var j=0; j<input.length; j++) {
            valid = valid && $(element).html().includes(input[j]);
            if(!valid)
              break; //end loop as soon as invalid
        }

        if(valid){
            $(element).addClass(normalStyle);
            $(element).removeClass(fadedStyle);
        }
        else {
            $(element).removeClass(normalStyle);
            $(element).addClass(fadedStyle);
        }
    }
}

// This function was used in it's entirety from an
// example by Michal Young in minijax.html. I only 
// altered the image size for my purposes.
function showTiles(text) {
   text = text.toUpperCase();  // tiles are letter-A.png, etc.
   tiles_html = "";  // Build up the html text of links
   for (var i=0; i < text.length; i++) {
       letter = text.charAt(i);
       if (! "ABCDEFGHIJKLMNOPQRSTUVWXYZ".includes(letter)) {
          continue;
       }
       var tileURL = "/static/img/letter-" + letter + ".png";
       var tileLink = "<img src='" + tileURL + "'/>";
       tiles_html = tiles_html + tileLink;
    }
    return tiles_html;
}
</script>

 </div> <!-- container -->
</body> </html>
